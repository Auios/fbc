EXEEXT=@EXEEXT@
FBC=@FBC@
HOST_OSFAMILY=@HOST_OSFAMILY@
srcdir=@srcdir@
VPATH=@srcdir@

MANIFEST := $(HOST_OSFAMILY).lst
MAKELIST := makelist$(EXEEXT)

.PHONY: all
all: $(MANIFEST)

$(MANIFEST): makelist.sh
	find $(srcdir)/.. -type f > big.lst
    # Remove $(srcdir)/../ prefixes to make the manifest entries relative to
    # the toplevel directory. The patterns from pattern.ini rely on that...
	sed big.lst -e 's,^$(srcdir)/\.\./,,g' > temp
	mv temp big.lst
    # Apply the patterns to the big list...
	sh makelist.sh big.lst $@
	rm big.lst
    # Sort the manifest: case-insensitive (more beautiful to look at),
    # removing duplicates (important, because makelist doesn't do it).
	sort --ignore-case --unique $(MANIFEST) > temp
	mv temp $(MANIFEST)

makelist.sh: makelist.sh.in pattern.ini $(MAKELIST)
	cp $< $@
	./$(MAKELIST) pattern.ini $@

$(MAKELIST): makelist.bas
	$(FBC) -g -exx -d HOST_OSFAMILY=$(HOST_OSFAMILY) $< -o $(patsubst %.bas,%.o,$<) -x $@

FB_VERSION := 0.22.0
ZIP_TITLE := fbc-$(FB_VERSION)
ZIP := $(ZIP_TITLE).zip
$(ZIP): $(MANIFEST)
    # Copy all files from the manifest into a local directory, so that
    # a) the content of the package is inside a directory (ready for "Extract Here"),
    # b) only stuff from the manifest is packaged.

    # Copy the manifest and add $(srcdir)/../ prefixes, so the files will be
    # found, and package all files from that list.
	sed $< -e 's,^,$(srcdir)/\.\.,g' > big.lst
	zip -@ -q -0 -r temp.zip < big.lst
	rm big.lst

    # Now repackage the .zip, this time with all files inside a directory,
    # so you can "Extrect Here" the .zip properly.
	mkdir $(ZIP_TITLE)
	unzip -q -o -d $(ZIP_TITLE) temp.zip
	rm temp.zip
	zip -q -9 -r $@ $(ZIP_TITLE)
	rm -r $(ZIP_TITLE)


.PHONY: zip
zip: $(ZIP)

.PHONY: clean
clean:
	-rm -f $(MAKELIST) makelist.sh $(MANIFEST)
